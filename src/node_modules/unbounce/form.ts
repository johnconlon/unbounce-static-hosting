import FauxFormData from "faux-form-data";

export type UnbounceForm = HTMLFormElement;

// TODO: more robust
export function getForm() {
  return document.querySelector(".lp-pom-form form");
}

// Doesn't work with radio, checkbox, or select inputs in the unbounce form. Use a hidden input for the
// radio instead. This is generally fince since the unbounce form is hidden anyway.
// That being said:
// TODO: support multiselect
export function fill(formData: FauxFormData, form: UnbounceForm) {
  formData.forEach((name: string, value: string[]) => {
    const field = form[name] as HTMLInputElement | RadioNodeList;

    if (!field) {
      throw new Error(`Cannot fill field ${name}. Field doesn't exist.`);
    }
    field.value = value[0];

    // If we're setting the value of a radio input and the value we're trying to set is
    // not one of the options in the radio group, the value won't change. Detect
    // that and throw an error so we can fix it.
    if (field.value !== value[0]) {
      throw new Error(
        `Value mismatch between dynamic form and unbounce form for field ${name} and value ${
          value[0]
        }`
      );
    }
  });
}

// Unbounce reacts to the submit event, so manually dispatch one.
export function submit(form: UnbounceForm) {
  const event = document.createEvent('Event')
  event.initEvent('submit', true, true)
  form.dispatchEvent(event)
}
